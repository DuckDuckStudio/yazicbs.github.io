name: 生成 Sitemap

on:
  push:
    branches:
      - main
      - sitemap-20241112
    paths:
      - '**/*.html'
  workflow_dispatch:

jobs:
  generate_sitemap:
    runs-on: ubuntu-latest

    steps:
      - name: 检出仓库
        uses: actions/checkout@v3

      - name: 设置 Node.js 环境
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: 创建 Sitemap
        run: node .action_scripts/JavaScript/generate-sitemap.mjs

      - name: 提交并推送 sitemap.xml
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          BRANCH_NAME="sitemap-update-$(date +%Y%m%d%H%M%S)"
          git checkout -b $BRANCH_NAME
          echo "已创建分支 $BRANCH_NAME"
          git config --global user.name "${{ secrets.BOT_ACCOUNT }}"
          git config --global user.email "${{ secrets.BOT_EMAIL }}"
          git add sitemap.xml
          git commit -m "更新 sitemap.xml"
          git push --set-upstream origin $BRANCH_NAME

          # 获取当前日期和时间
          DATE_TIME=$(date '+%Y/%m/%d %H:%M')
          
          # 使用 GitHub CLI 创建 PR，标题使用当前日期时间，内容使用仓库默认模板
          gh pr create --title "[${DATE_TIME}] Auto update sitemap" \
                       --body "" \
                       --base main \
                       --head $BRANCH_NAME \
                       --reviewer fjwxzde \
                       --reviewer DuckDuckStudio

          echo "Pull Request 创建成功。"
